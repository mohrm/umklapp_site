{% extends request.is_ajax|yesno:"umklapp/base_ajax.html,umklapp/base.html"%}
{% load bootstrap %}
{% block title %}Das Umklappspiel{% endblock %}

{% block pretitle %}{% if action_count %}({{action_count}}) {% endif %}{% endblock %}

{% block content %}
<div class="container">
<h2>Willst Du eine neue Geschichte starten?</h2>
<a href="{% url 'new_story' %}">Neue Geschichte starten</a><p/>
<h2>Laufende Geschichten</h2>
{% if running_stories %}
  <table class="table">
   <thead class="hidden-xs">
    <tr>
     <th style="width:99%">Titel</th>
     <th class="text-right">Sätze</th>
     <th class="text-right">Erzähler</th>
     <th class="text-right">Nächster</th>
     <th class="text-right">Aktionen</th>
    </tr>
   </thead>
   <tbody>
    {% for s in running_stories %}
     <tr {% if s.waiting_for = user %} class="success" {% endif %}>
      {# dynamic width, but ellipsize the text: http://stackoverflow.com/a/20412246/946226  #}
      <td style="max-width:1px;text-overflow:ellipsis; overflow:hidden; white-space:nowrap;width:100%">{{ s.title }}</td>
      <td class="text-right hidden-xs">{{ s.parts.count }}</td>
      <td class="text-right hidden-xs">{{ s.numberOfActiveTellers }}</td>
      <td class="text-right hidden-xs">{{ s.waiting_for }}</td>
      <td class="text-right" style="white-space: nowrap">

       {% if s.waiting_for = user %}
        <a title="Geschichte fortsetzen" class="btn btn-primary btn-sm" href="{% url 'continue_story' story_id=s.id %}"><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></a>
       {% else %}
	<span class="invisible">
         <button class="btn btn-primary btn-sm" disabled="disabled" href=""><span class="glyphicon glyphicon-pencil" aria-hidden="true"></span></button>
	</span>
       {% endif %}

	{% if specialpowers or s.waiting_for = user %}
	 <form  style="display:inline" method="post" action="skip">
           {% csrf_token %}
           <input type="hidden" name="story_id" value="{{ s.id }}"/>
           <button title="Überspringen" type="submit" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-fast-forward" aria-hidden="true"></span></button>
	 </form>
	{% else %}
	   <span class="invisible">
            <button type="submit" class="btn btn-default btn-sm" disabled="disabled"><span class="glyphicon glyphicon-fast-forward" aria-hidden="true"></span></button>
	   </span>
	{% endif %}

	<form style="display:inline" method="post" action="leave_story">
          {% csrf_token %}
	  <input type="hidden" name="story_id" value="{{ s.id }}"/>
	  <button title="Geschichte verlassen" type="submit" class="btn btn-default btn-sm"><span class="glyphicon glyphicon-remove" aria-hidden="true"></span></button>
	</form>

      </td>
     </tr>
   {% endfor %}
   </tbody>
  </table>
{% else %}
<p>Es gibt gerade keine laufenden Geschichten.</p>
{% endif %}
</div>

<div class="container">
<div class="row">
<div class="col-md-6">
<h2>Beendete Geschichten </h2>
{% if finished_stories %}
  <table class="table">
   <thead class="hidden-xs">
    <tr>
     <th style="width:99%">Titel</th>
     <th class="text-right hidden-xs">Sätze</th>
     <th class="text-right hidden-xs">Erzähler</th>
     <th class="text-right">Aktionen</th>
    </tr>
   </thead>
   <tbody>
    {% for s in finished_stories %}
      <td>{{ s.title }}</td>
      <td class="text-right hidden-xs">{{ s.parts.count }}</td>
      <td class="text-right hidden-xs">{{ s.numberOfActiveTellers }}</td>
      <td class="text-right" style="white-space: nowrap">
        {% if s.started_by = user %}
          {% if not s.is_public %}
            <a title="Erlaube allen die Geschichte zu sehen" class="btn btn-primary btn-sm" href="{% url 'publish_story' story_id=s.id %}"><span class="glyphicon glyphicon-sunglasses" aria-hidden="true" /></a>
          {% else %}
            <a title="Erlaube doch NICHT allen die Geschichte zu sehen" class="btn btn-primary btn-sm" href="{% url 'unpublish_story' story_id=s.id %}"><span class="glyphicon glyphicon-lock" aria-hidden="true" /></a>
          {% endif %}
        {% endif %}
        <a title="Geschichte lesen" class="btn btn-primary btn-sm" href="{% url 'show_story' story_id=s.id %}"><span class="glyphicon glyphicon-book" aria-hidden="true"></span></a>
      </td>
     </tr>
   {% endfor %}
   </tbody>
  </table>
{% else %}
<p>Es gibt gerade keine fertigen Geschichten.</p>
{% endif %}
</div>

<div class="col-md-6">
{% if user_activity %}
<h2>Die fleißigsten Erzähler</h2>
<table class="table">
 <thead>
  <tr>
   <th>#</th>
   <th style="width:100%">Erzähler</th>
   <th class="text-right">Sätze</th>
  </tr>
 </thead>
 <tbody>
  {% for u in user_activity %}
   <tr>
    <td>{% ifchanged u.parts_written %}{{ forloop.counter }}{% endifchanged %}</td>
    <td>{{ u.username }}</td>
    <td class="text-right">{{ u.parts_written }}</td>
   </tr>
  {% endfor %}
 </tbody>
</table>
{% endif %}
</div>
</div>
</div>
{% endblock %}

{% block pageend %}
<script>
/*  http://stackoverflow.com/a/13324909/946226 */
$(function() {
    setTimeout(startRefresh,20*1000);
});

function startRefresh() {
    $.get('/', function(data) {
        $('#content').html(data);
	if ($('#settitle')) {
	    $('title').text($('#settitle').text());
	    $('#settitle').remove();
	}
    });
}
</script>
{% endblock %}

